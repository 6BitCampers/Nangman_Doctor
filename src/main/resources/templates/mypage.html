<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}" xmlns="">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<div layout:fragment="content">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.0/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.0/dist/sweetalert2.all.min.js"></script>
    <!--
// v0 by Vercel.
// https://v0.dev/t/nULdeR4ujUU
-->

    <div class="grid grid-cols-[300px_1fr_300px] gap-8 max-w-6xl mx-auto py-10 px-4">
        <div class="bg-background rounded-lg shadow-lg p-6">
            <div class="flex items-center gap-4">
      <span class="relative flex shrink-0 overflow-hidden rounded-full w-12 h-12">
        <img class="aspect-square h-full w-full" th:src="@{/images/placeholder-user.jpg}"/>
      </span>
                <div>
                    <h3 class="font-semibold text-lg" th:text="${udto.user_name}"></h3>
                    <p class="text-muted-foreground text-sm" th:text="${udto.user_email}"></p>
                    <p class="text-muted-foreground text-sm" th:text="${udto.user_hp}"></p>
                </div>
            </div>
            <div data-orientation="horizontal" role="none" class="shrink-0 bg-border h-[1px] w-full my-4"></div>
            <div class="grid gap-2">
                <div class="flex items-center justify-between">
                    <span class="text-muted-foreground">Address: </span>
                    <span class="font-medium" th:text="${udto.user_addr1}"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-muted-foreground">Age Range:</span>
                    <span class="font-medium" th:text="${udto.getUser_age()}"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-muted-foreground">Total Reservations:</span>
                    <span class="font-medium" th:text="${reservationList==null?0:reservationList.size()}"></span>
                </div>
            </div>
            <div data-orientation="horizontal" role="none" class="shrink-0 bg-border h-[1px] w-full my-4"></div>
            <div class="grid gap-2">
                <a th:href="@{/mypage/updateform}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" style="text-decoration: none;">
                    Edit Profile
                </a>
                <button onclick="resetPw(event)" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Change Password
                </button>
                <script>
                    function resetPw(e) {
                        e.preventDefault();
                        (async () => {
                            const { value: formValues } = await Swal.fire({
                                title: '비밀번호 재설정',
                                html:
                                    '<label for="swal-input1">이름</label><input id="swal-input1" class="swal2-input"><br>' +
                                    '<label for="swal-input2">이메일</label><input id="swal-input2" class="swal2-input">',
                                focusConfirm: false,
                                preConfirm: () => {
                                    return [
                                        document.getElementById('swal-input1').value,
                                        document.getElementById('swal-input2').value
                                    ]
                                }
                            })

                            if (formValues) {
                                $.ajax({
                                    url:"api/v1/searchPW",
                                    data:{"name":formValues[0],"email":formValues[1]},
                                    type:"get",
                                    async:false,
                                    complete: function(e, xhr, settings){
                                        if(e.status === 200){
                                            Swal.fire({
                                                icon: 'success',
                                                title: '찾기 성공!',
                                                text: formValues[0]+'님, '+formValues[1]+'로 전송을 완료 했습니다.',
                                            });
                                        }else{
                                            Swal.fire({
                                                icon: 'error',
                                                title: '찾기 실패',
                                                text: '맞는 계정이 없습니다!',
                                            });
                                        }
                                    }
                                })
                            }
                        })()
                    }
                </script>
                <a th:href="@{/logout}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                Log out
                </a>
            </div>
        </div>


        <div class="bg-background rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Reservation Status</h2>
            <div class="grid gap-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span>Completed</span>
                    </div>
                    <span class="font-medium" th:text="${completed==null?0:completed}"></span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                        <span>Reserved</span>
                    </div>
                    <span class="font-medium" th:text="${reserved==null?0:reserved}"></span>
                </div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-pink-300"></div>
                        <span>Pending</span>
                    </div>
                    <span class="font-medium" th:text="${pending==null?0:pending}"></span>
                </div>
            </div>
            <div data-orientation="horizontal" role="none" class="shrink-0 bg-border h-[1px] w-full my-4"></div>
            <div class="grid gap-4">
                <h3 class="text-lg font-semibold">Recent Reservations</h3>
                <div class="grid gap-2">
                    <div class="flex items-center justify-between" th:if="${reservationList==null}">
                        <h4 class="font-medium">No Reservation On load</h4>
                    </div>
                    <div class="flex items-center justify-between bg-background rounded-medium shadow-sm p-2" th:each="reservation,iterStat: ${reservationList}" th:id="'reservation-' + ${iterStat.index}">
                        <div>
                            <h4 class="font-medium" th:text="${reservation.get('reservation_reason')}"></h4><br>
                            <p class="text-muted-foreground text-sm"><span th:text="${reservation.get('reservation_date')}"></span> <span th:text="${reservation.get('reservation_time')}"></span></p>
                        </div>

                        <button type="button" class="btn btn-primary btn-sm"
                                th:data-id="${reservation.get('reservation_no')}"
                                th:onclick="'editReservation('+${reservation.get('reservation_no')} + ')'">수정</button>

                        <button type="button" class="btn btn-danger btn-sm"
                                th:data-id="${reservation.get('reservation_no')}"
                                th:onclick="'deleteReservation(' + ${reservation.get('reservation_no')} + ')'">삭제</button>
                        <div
                                class="inline-flex w-fit items-center whitespace-nowrap rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 text-foreground"
                                data-v0-t="badge"
                                th:text="${reservation.get('status')}"
                        >
                        </div>
                    </div><!--each end-->
                    </div>
                </div>
            </div>
        <div class="calendar-container">
            <div class="calendar-header">
                <button onclick="navigateMonth(-1)">이전</button>
                <h2 id="currentMonthYear"></h2>
                <button onclick="navigateMonth(1)">다음</button>
            </div>
            <table class="calendar-table">
                <thead>
                <tr>
                    <th>일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th>토</th>
                </tr>
                </thead>
                <tbody id="calendarBody">
                </tbody>
            </table>
        </div>
        </div>






        <!-- 예약목록 -->
        <div class="flex-fill p-3 bg-light rounded shadow-sm d-flex flex-column justify-content-start m-3" hidden>
            <h2>예약 목록</h2>
            <br>
            <div class="col-md-8">
                <ul class="list-unstyled w-100 mb-3">
                    <li th:each="reservation, iterStat : ${reservationList}" th:id="'reservation-' + ${iterStat.index}"
                        class="bg-white border rounded p-3 shadow-sm mb-3" th:if="${reservation.get('reservation_status') != 3}">
                        <h2 class="h5">예약 번호: <span th:text="${reservation.get('reservation_no')}">1</span></h2>
                        <p>이름: <span th:text="${reservation.get('user_name')}">홍길동</span></p>
                        <p>날짜: <span th:text="${reservation.get('reservation_date')}">2023-01-01</span></p>
                        <p>시간: <span th:text="${reservation.get('reservation_time')}">10:00 - 11:00</span></p>
                        <p>진료명: <span th:text="${reservation.get('reservation_reason')}">진료명</span></p>
                        <p>상태:
                            <span th:if="${reservation.get('reservation_status') == 1}" class="text-warning">예약 요청</span>
                            <span th:if="${reservation.get('reservation_status') == 2}" class="text-info" style="display: inline-flex; align-items: center; gap: 5px;">예약 확정
                         <button type="button" class="btn btn-primary btn-sm"
                                 th:data-id="${reservation.get('reservation_no')}"
                                 th:onclick="'editReservation('+${reservation.get('reservation_no')} + ')'">수정</button>

                             <button type="button" class="btn btn-danger btn-sm"
                                     th:data-id="${reservation.get('reservation_no')}"
                                     th:onclick="'deleteReservation(' + ${reservation.get('reservation_no')} + ')'">삭제</button>

                           </span>


                        </p>

                    </li>
                </ul>
            </div>
            <script th:inline="javascript">

                function editReservation(reservationNo) {
                    if (confirm("현재 예약이 삭제되며 예약 페이지로 이동합니다")) {
                        window.location.href = "/edit?reservationNo=" + reservationNo;
                    }
                }

                function deleteReservation(reservationNo) {
                    $.ajax({
                        type: "POST",
                        url: "/delete",
                        data: { reservationNo: reservationNo },
                        success: function(response) {
                            if (response === "success") {
                               alert("예약이 삭제되었습니다.")
                                // 필요 시 페이지 새로고침 또는 다른 동작 수행
                                location.reload();
                            } else {
                                alert("예약 삭제에 변수발생");
                            }
                        },
                        error: function() {
                            alert("Error occurred while deleting reservation");
                        }
                    });
                }

            </script>
        </div>


        <style>
            .btn {
                padding: 5px 10px;
                margin: 2px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .btn-success {
                background-color: green;
            }

            .btn-danger {
                background-color: red;
            }

            .calendar-container {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                padding: 20px;
                width: 500px;
            }

            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                max-width: 600px;
                margin-bottom: 20px;
            }

            .calendar-header button {
                padding: 5px 10px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .calendar-header button:hover {
                background-color: orange;
            }

            .calendar-table {
                width: 100%;
                max-width: 600px;
                border-collapse: collapse;
            }

            .calendar-table th, .calendar-table td {
                border: 1px solid #ddd;
                padding: 10px;
                text-align: center;
            }

            .calendar-table td {
                position: relative;
                background-color: white;
            }

            .calendar-table td:hover {
                background-color: #f1f1f1;
            }

            .video-call-button {
                padding: 5px 10px;
                margin-top: 5px;
                background-color: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .video-call-button:hover {
                background-color: #218838;
            }
        </style>


        <script th:inline="javascript">
            let reservationList = /*[[${reservationList}]]*/ [];
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();

            function renderCalendar(month, year) {
                const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월",
                    "7월", "8월", "9월", "10월", "11월", "12월"];
                const firstDay = new Date(year, month).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const calendarBody = document.getElementById("calendarBody");
                const currentMonthYear = document.getElementById("currentMonthYear");
                calendarBody.innerHTML = "";
                currentMonthYear.innerText = `${monthNames[month]} ${year}`;

                let date = 1;
                for (let i = 0; i < 6; i++) {
                    const row = document.createElement("tr");
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement("td");
                        const cellContent = document.createElement("div");
                        cellContent.style.display = "flex";
                        cellContent.style.flexDirection = "column";
                        cellContent.style.alignItems = "center";

                        if (i === 0 && j < firstDay) {
                            cell.innerText = "";
                        } else if (date > daysInMonth) {
                            break;
                        } else {
                            const dateDiv = document.createElement("div");
                            dateDiv.innerText = date;
                            cellContent.appendChild(dateDiv);

                            // Check for reservations on this date
                            const reservation = reservationList.find(reservation => {
                                const resDate = new Date(reservation.reservation_date);
                                return resDate.getDate() === date && resDate.getMonth() === month && resDate.getFullYear() === year && (reservation.reservation_status === 2 || reservation.reservation_status === 3);
                            });



                            if (reservation) {
                                if (reservation.reservation_status === 3) {
                                    const button = document.createElement("button");
                                    button.classList.add("btn", "btn-primary"); // Bootstrap 버튼 스타일 클래스 추가
                                    button.setAttribute("type", "button");
                                    button.setAttribute("data-bs-toggle", "modal"); // Bootstrap 모달 토글 속성 추가
                                    button.setAttribute("data-bs-target", "#exampleModal"); // Bootstrap 모달 타겟 속성 추가
                                    button.innerText = "결제";
                                    // button.addEventListener("click", function() {
                                    //     window.location.href = `/test?reservation_no=${reservation.reservation_no}`;
                                    // });
                                    cellContent.appendChild(button);
                                }

                                else if (reservation.reservation_face === 2 && reservation.reservation_status === 2) {
                                    const button = document.createElement("button");
                                    button.classList.add("video-call-button");
                                    button.innerText = "화상진료";
                                    button.addEventListener("click", function() {
                                        window.open('https://webchat.midichi.kro.kr/');
                                        window.location.href = `/test?reservation_no=${reservation.reservation_no}`;
                                    });
                                    cellContent.appendChild(button);
                                } else if (reservation.reservation_face === 1 && reservation.reservation_status === 2) {
                                    const text = document.createElement("span");
                                    text.classList.add("in-person-appointment");
                                    text.innerText = "대면 진료";
                                    text.style.backgroundColor = "yellow";
                                    text.style.padding = "0 5px";
                                    text.style.borderRadius = "3px";
                                    text.style.fontWeight = "bold";
                                    cellContent.appendChild(text);
                                }
                            }

                            date++;
                        }
                        cell.appendChild(cellContent);
                        row.appendChild(cell);
                    }
                    calendarBody.appendChild(row);
                }
            }


            function navigateMonth(offset) {
                currentMonth += offset;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                } else if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            }

            document.addEventListener("DOMContentLoaded", () => {
                renderCalendar(currentMonth, currentYear);
            });

            function openPopup(){
            // 팝업 옵션 설정: 스크롤바 없애고, 확대/축소 가능하도록
            var popupOptions = 'width=900,height=1200,resizable=yes,scrollbars=no';

            // 팝업 창을 중앙에 위치시키기 위한 계산
            var left = (screen.width - 900) / 2;
            var top = (screen.height - 1200) / 2;
            popupOptions += `,left=${left},top=${top}`;

            // 새로운 윈도우를 팝업으로 엽니다.
            var popupWindow = window.open('', 'popupWindow', popupOptions);

            // 팝업 윈도우에 폼을 제출합니다.
            var form = document.getElementById('popupForm');
            form.target = 'popupWindow'; // 폼의 target을 팝업 윈도우로 설정
            form.submit();
            }
        </script>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">결제정보</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div th:each="dto : ${dto}" class="modal-body">
                    <table class="table table-striped mt-3" style="height: auto">
                        <tr>
                            <th>결제정보</th>
                            <td th:text="${dto.receipt_name}"></td>
                        </tr>
                        <tr>
                        <tr>
                            <th>방문 병원</th>
                            <input type="hidden" id="myPageInfoNo" th:value="${dto.info_no}">
                            <td id="visitedHospitalName"></td>
                        </tr>
                        <script>
                            $(document).ready(function() {
                                var infoNo = $('#myPageInfoNo').val();
                                if (infoNo) {
                                    $.ajax({
                                        url: '/getHospitalName', // 서버의 엔드포인트 URL을 여기에 입력하세요
                                        type: 'GET',
                                        data: { info_no: infoNo },
                                        success: function(response) {
                                            // 서버 응답에서 info_name을 가져와서 표시
                                            $('#visitedHospitalName').text(response.info_name);
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('AJAX 요청 실패:', status, error);
                                        }
                                    });
                                }
                            });
                        </script>
                        <tr>
                            <th>진료일</th>
                            <td th:text="${dto.receipt_date}"></td>
                        </tr>
                        <tr>
                            <th>결제금액</th>
                            <td th:text="${dto.receipt_amount}"></td>
                        </tr>
                        <tr>
                            <th>결제 상태</th>
                            <td th:switch="${dto.payment_no}">
                                <span th:case="0">미결제 상태</span>
                                <span th:case="*">결제 완료</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="text-align: center;">
                                <!-- 결제 하러 가기 버튼 -->
                                <form action="/payment" method="post" style="display: inline;">
                                    <input type="hidden" name="receipt_no" th:value="${dto.receipt_no}">
                                    <input type="hidden" name="user_no" th:value="${udto.user_no}">
                                    <button type="submit" class="btn btn-primary mt-3" th:if="${dto.payment_no == 0}">
                                        결제 하러 가기
                                    </button>
                                </form>
                                <div th:if="${dto.payment_no != 0}" style="display: flex; justify-content: center; gap: 10px;">
                                    <form method="post" th:action="@{/reviewboard/write}">
                                        <input type="hidden" name="user_no" th:value="${userNo}">
                                        <input type="hidden" name="receipt_no" th:value="${dto.receipt_no}">
                                        <button type="submit" class="btn btn-primary mt-3">리뷰 쓰러 가기</button>
                                    </form>
                                    <form th:action="@{/receiptView}" method="post" id="popupForm" target="popupWindow" style="display: inline;">
                                        <input type="hidden" name="receipt_no" th:value="${dto.getReceipt_no()}">
                                        <button type="submit" class="btn btn-primary mt-3 receiptView" onclick="openPopup()">처방전 열람</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>
</html>


