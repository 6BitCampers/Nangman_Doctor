<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}" xmlns="">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<div layout:fragment="content">

    <div th:if="${udto != null}" class="d-flex vh-100 bg-warning p-3 gap-3" style="height: auto">
        <div class="flex-fill p-3 bg-light rounded shadow-sm d-flex flex-column justify-content-start m-3">
            <div class="d-flex justify-content-end mb-3">
                <a href="/mypage/updateform" class="text-decoration-none text-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                    </svg>
                </a>
            </div>
            <h1 th:text="${udto.user_name} + '님 환영합니다!'"></h1>
            <table class="table table-striped mt-3">
                <tr>
                    <th>이름</th>
                    <td th:text="${udto.user_name}"></td>
                </tr>
                <tr>
                    <th>이메일</th>
                    <td th:text="${udto.user_email}"></td>
                </tr>
                <tr>
                    <th>전화번호</th>
                    <td th:text="${udto.user_hp}"></td>
                </tr>
                <tr>
                    <th>닉네임</th>
                    <td th:text="${udto.user_nickname}"></td>
                </tr>
                <tr>
                    <th>성별</th>
                    <td th:text="${udto.user_gender}"></td>
                </tr>
                <tr>
                    <th>주소</th>
                    <td th:text="${udto.user_addr1}"></td>
                </tr>
                <tr th:if="${udto.user_interest != null}">
                    <th>관심분야</th>
                    <td th:text="${udto.user_interest}"></td>
                </tr>
            </table>
            <span th:if="${status == 1}">
                <button type="button" onclick="location.href='/test'" class="btn btn-primary mt-3">
                    화상진료하러가기
                </button>
                <script>
                    document.querySelector('button').addEventListener('mouseover', function() {
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-dark');
                    });
                    document.querySelector('button').addEventListener('mouseout', function() {
                        this.classList.remove('btn-dark');
                        this.classList.add('btn-primary');
                    });
                </script>
            </span>
            <span th:if="${status != 1}">
                <h1>화상진료 예약일이 아닙니다.</h1>
            </span>
            <br><br>
                <div th:each="dto : ${dto}">
                    <div>
                    <table class="table table-striped mt-3" style="height: auto">
                        <tr>
                            <th>결제정보</th>
                            <td th:text="${dto.receipt_name}"></td>
                        </tr>
                        <tr>
                        <tr>
                            <th>방문 병원</th>
                            <input type="hidden" id="myPageInfoNo" th:value="${dto.info_no}">
                            <td id="visitedHospitalName"></td>
                        </tr>
                        <script>
                            $(document).ready(function() {
                                var infoNo = $('#myPageInfoNo').val();
                                if (infoNo) {
                                    $.ajax({
                                        url: '/getHospitalName', // 서버의 엔드포인트 URL을 여기에 입력하세요
                                        type: 'GET',
                                        data: { info_no: infoNo },
                                        success: function(response) {
                                            // 서버 응답에서 info_name을 가져와서 표시
                                            $('#visitedHospitalName').text(response.info_name);
                                        },
                                        error: function(xhr, status, error) {
                                            console.error('AJAX 요청 실패:', status, error);
                                        }
                                    });
                                }
                            });
                        </script>
                        <tr>
                            <th>진료일</th>
                            <td th:text="${dto.receipt_date}"></td>
                        </tr>
                        <tr>
                            <th>결제금액</th>
                            <td th:text="${dto.receipt_amount}"></td>
                        </tr>
                        <tr>
                            <th>결제 상태</th>
                            <td th:switch="${dto.payment_no}">
                                <span th:case="0">미결제 상태</span>
                                <span th:case="*">결제 완료</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" style="text-align: center;">
                                <!-- 결제 하러 가기 버튼 -->
                                <form action="/payment" method="post" style="display: inline;">
                                    <input type="hidden" name="receipt_no" th:value="${dto.receipt_no}">
                                    <input type="hidden" name="user_no" th:value="${udto.user_no}">
                                    <button type="submit" class="btn btn-primary mt-3" th:if="${dto.payment_no == 0}">
                                        결제 하러 가기
                                    </button>
                                </form>

                                <!-- 결제 완료된 경우 리뷰 쓰러 가기와 처방전 열람 -->
                                <div th:if="${dto.payment_no != 0}" style="display: flex; justify-content: center; gap: 10px;">
                                    <form method="post" th:action="@{/reviewboard/write}">
                                        <input type="hidden" name="user_no" th:value="${userNo}">
                                        <input type="hidden" name="receipt_no" th:value="${dto.receipt_no}">
                                    <button type="submit" class="btn btn-primary mt-3">리뷰 쓰러 가기</button>
                                    </form>
                                    <form th:action="@{/receiptView}" method="post" id="popupForm" target="popupWindow" style="display: inline;">
                                        <input type="hidden" name="receipt_no" th:value="${dto.getReceipt_no()}">
                                        <button type="submit" class="btn btn-primary mt-3 receiptView" onclick="openPopup()">처방전 열람</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </table>
                    </div>
                </div>
            <script>
                function openPopup() {
                    // 팝업 옵션 설정: 스크롤바 없애고, 확대/축소 가능하도록
                    var popupOptions = 'width=900,height=1200,resizable=yes,scrollbars=no';

                    // 팝업 창을 중앙에 위치시키기 위한 계산
                    var left = (screen.width - 900) / 2;
                    var top = (screen.height - 1200) / 2;
                    popupOptions += `,left=${left},top=${top}`;

                    // 새로운 윈도우를 팝업으로 엽니다.
                    var popupWindow = window.open('', 'popupWindow', popupOptions);

                    // 팝업 윈도우에 폼을 제출합니다.
                    var form = document.getElementById('popupForm');
                    form.target = 'popupWindow'; // 폼의 target을 팝업 윈도우로 설정
                    form.submit();
                }
            </script>

        </div>

<!--        <div th:if="${edto != null}" class="flex-fill p-3 bg-light rounded shadow-sm d-flex flex-column justify-content-start m-3">-->
<!--            <div class="d-flex justify-content-end mb-3">-->
<!--                <a href="#" class="text-decoration-none text-dark">-->
<!--                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">-->
<!--                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>-->
<!--                        <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>-->
<!--                    </svg>-->
<!--                </a>-->
<!--            </div>-->
<!--            <h1 th:text="${edto.employee_name} + '님 환영합니다!'"></h1>-->
<!--            <table class="table table-striped mt-3">-->
<!--                <tr>-->
<!--                    <th>이름</th>-->
<!--                    <td th:text="${edto.employee_name}"></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <th>이메일</th>-->
<!--                    <td th:text="${edto.employee_email}"></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <th>전화번호</th>-->
<!--                    <td th:text="${edto.employee_phone}"></td>-->
<!--                </tr>-->
<!--                <tr>-->
<!--                    <th>직책</th>-->
<!--                    <td th:text="${edto.employee_position}"></td>-->
<!--                </tr>-->
<!--                <tr th:if="${edto.employee_department != null}">-->
<!--                    <th>부서</th>-->
<!--                    <td th:text="${edto.employee_department}"></td>-->
<!--                </tr>-->
<!--            </table>-->
<!--        </div>-->


        <!-- 예약목록 -->
        <div class="flex-fill p-3 bg-light rounded shadow-sm d-flex flex-column justify-content-start m-3">
            <h2>예약 목록</h2>
            <br>
            <div class="col-md-8">
                <ul class="list-unstyled w-100 mb-3">
                    <li th:each="reservation, iterStat : ${reservationList}" th:id="'reservation-' + ${iterStat.index}"
                        class="bg-white border rounded p-3 shadow-sm mb-3" th:if="${reservation.get('reservation_status') != 3}">
                        <h2 class="h5">예약 번호: <span th:text="${reservation.get('reservation_no')}">1</span></h2>
                        <p>이름: <span th:text="${reservation.get('user_name')}">홍길동</span></p>
                        <p>날짜: <span th:text="${reservation.get('reservation_date')}">2023-01-01</span></p>
                        <p>시간: <span th:text="${reservation.get('reservation_time')}">10:00 - 11:00</span></p>
                        <p>진료명: <span th:text="${reservation.get('reservation_reason')}">진료명</span></p>
                        <p>상태:
                            <span th:if="${reservation.get('reservation_status') == 1}" class="text-warning">예약 요청</span>
                            <span th:if="${reservation.get('reservation_status') == 2}" class="text-info" style="display: inline-flex; align-items: center; gap: 5px;">예약 확정
                         <button type="button" class="btn btn-primary btn-sm"
                                 th:data-id="${reservation.get('reservation_no')}"
                                 th:onclick="'editReservation('+${reservation.get('reservation_no')} + ')'">수정</button>

                             <button type="button" class="btn btn-danger btn-sm"
                                     th:data-id="${reservation.get('reservation_no')}"
                                     th:onclick="'deleteReservation(' + ${reservation.get('reservation_no')} + ')'">삭제</button>

                           </span>


                        </p>

                    </li>
                </ul>
            </div>
            <script th:inline="javascript">

                function editReservation(reservationNo) {
                    if (confirm("수정하겠습니까? 수정하시면 지금 예약이 삭제됩니다.")) {
                        window.location.href = "/edit?reservationNo=" + reservationNo;
                    }
                }



                function deleteReservation(reservationNo) {
                    $.ajax({
                        type: "POST",
                        url: "/delete",
                        data: { reservationNo: reservationNo },
                        success: function(response) {
                            if (response === "success") {
                                alert("Reservation deleted successfully");
                                // 필요 시 페이지 새로고침 또는 다른 동작 수행
                                location.reload();
                            } else {
                                //alert("Failed to delete reservation");
                            }
                        },
                        error: function() {
                            alert("Error occurred while deleting reservation");
                        }
                    });
                }
            </script>
            </div>
        <div class="calendar-container">
            <div class="calendar-header">
                <button onclick="navigateMonth(-1)">이전</button>
                <h2 id="currentMonthYear"></h2>
                <button onclick="navigateMonth(1)">다음</button>
            </div>
            <table class="calendar-table">
                <thead>
                <tr>
                    <th>일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th>토</th>
                </tr>
                </thead>
                <tbody id="calendarBody">
                </tbody>
            </table>
        </div>

        <style>
            .btn {
                padding: 5px 10px;
                margin: 2px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .btn-success {
                background-color: green;
            }

            .btn-danger {
                background-color: red;
            }

            .calendar-container {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                padding: 20px;
            }

            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                max-width: 600px;
                margin-bottom: 20px;
            }

            .calendar-header button {
                padding: 5px 10px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .calendar-header button:hover {
                background-color: orange;
            }

            .calendar-table {
                width: 100%;
                max-width: 600px;
                border-collapse: collapse;
            }

            .calendar-table th, .calendar-table td {
                border: 1px solid #ddd;
                padding: 10px;
                text-align: center;
            }

            .calendar-table th {
                background-color: orange;
                color: white;
            }

            .calendar-table td {
                position: relative;
                background-color: white;
            }

            .calendar-table td:hover {
                background-color: #f1f1f1;
            }

            .video-call-button {
                padding: 5px 10px;
                margin-top: 5px;
                background-color: #28a745;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .video-call-button:hover {
                background-color: #218838;
            }
        </style>




            <script th:inline="javascript">
                let reservationList = /*[[${reservationList}]]*/ [];
                let currentMonth = new Date().getMonth();
                let currentYear = new Date().getFullYear();

                function renderCalendar(month, year) {
                    const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월",
                        "7월", "8월", "9월", "10월", "11월", "12월"];
                    const firstDay = new Date(year, month).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    const calendarBody = document.getElementById("calendarBody");
                    const currentMonthYear = document.getElementById("currentMonthYear");
                    calendarBody.innerHTML = "";
                    currentMonthYear.innerText = `${monthNames[month]} ${year}`;

                    let date = 1;
                    for (let i = 0; i < 6; i++) {
                        const row = document.createElement("tr");
                        for (let j = 0; j < 7; j++) {
                            const cell = document.createElement("td");
                            const cellContent = document.createElement("div");
                            cellContent.style.display = "flex";
                            cellContent.style.flexDirection = "column";
                            cellContent.style.alignItems = "center";

                            if (i === 0 && j < firstDay) {
                                cell.innerText = "";
                            } else if (date > daysInMonth) {
                                break;
                            } else {
                                const dateDiv = document.createElement("div");
                                dateDiv.innerText = date;
                                cellContent.appendChild(dateDiv);

                                // Check for reservations on this date
                                const reservation = reservationList.find(reservation => {
                                    const resDate = new Date(reservation.reservation_date);
                                    return resDate.getDate() === date && resDate.getMonth() === month && resDate.getFullYear() === year && reservation.reservation_status === 2;
                                });

                                if (reservation) {
                                    if (reservation.reservation_face === 2) {
                                        const button = document.createElement("button");
                                        button.classList.add("video-call-button");
                                        button.innerText = "화상채팅";
                                        button.addEventListener("click", function() {
                                            window.open('https://webchat.midichi.kro.kr/');
                                            window.location.href = `/test?reservation_no=${reservation.reservation_no}`;
                                        });
                                        cellContent.appendChild(button);
                                    } else if (reservation.reservation_face === 1) {
                                        const text = document.createElement("span");
                                        text.classList.add("in-person-appointment");
                                        text.innerText = "대면 진료";
                                        text.style.backgroundColor = "yellow";
                                        text.style.padding = "0 5px";
                                        text.style.borderRadius = "3px";
                                        text.style.fontWeight = "bold";
                                        cellContent.appendChild(text);
                                    }
                                }

                                date++;
                            }
                            cell.appendChild(cellContent);
                            row.appendChild(cell);
                        }
                        calendarBody.appendChild(row);
                    }
                }


                function navigateMonth(offset) {
                currentMonth += offset;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                } else if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar(currentMonth, currentYear);
            }

            document.addEventListener("DOMContentLoaded", () => {
                renderCalendar(currentMonth, currentYear);
            });
        </script>

        </div>
    </div>
</html>


